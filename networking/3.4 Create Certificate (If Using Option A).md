# Task 3.4: Create Certificate (If Using Option A)

**Objective**: Generate SSL certificate using DNS-01 challenge.

**Steps**:
1. In OPNsense: **Services → ACME Client → Certificates**
2. Click **Add**
3. Configure:
   - **Name**: `homelab-cert`
   - **Account**: Select account from Task 3.3
   - **Domain**: `yourdomain.com` or `*.yourdomain.com` (wildcard)
   - **Challenge Type**: `DNS-01` (NOT HTTP-01)
   - **DNS API**: Configure your DNS provider (Cloudflare, etc.)
4. Click **Save**
5. Click **Issue/Renew** to generate certificate

**Test**:
```bash
# Verify certificate created
# Navigate to: Services → ACME Client → Certificates
# Should see certificate with valid expiration date
```

**Expected Result**: SSL certificate is generated and ready to use.

---

## Testing Checklist

After completing all tasks, verify:

- [ ] DNS resolution works: `nslookup numenor.cuffney.com`, `nslookup shire.cuffney.com`
- [ ] SSH works using FQDNs: `ssh jcuffney@numenor.cuffney.com`, `ssh jcuffney@shire.cuffney.com`
- [ ] VPN connects successfully from external network using `shire.cuffney.com`
- [ ] VPN clients can access LAN services (Proxmox, VMs, etc.)
- [ ] VPN clients can resolve FQDNs (numenor.cuffney.com, shire.cuffney.com, VMs)
- [ ] Services are NOT accessible from public internet (without VPN)
- [ ] Only WireGuard port (51820/UDP) is accessible from internet
- [ ] Route 53 records exist for all hosts (for external/VPN access)

---

## Notes

- Complete tasks in order - each task builds on previous ones
- Test each task before moving to the next
- If a task fails, troubleshoot before continuing
- Keep notes of any customizations or deviations
- Backup OPNsense configuration after major changes

---

## Troubleshooting Quick Reference

**DNS not resolving**:
- Check Unbound is enabled: `Services → Unbound DNS → General`
- Verify DNS override exists: `Services → Unbound DNS → Overrides`
- Test: `dig @192.168.1.1 numenor.cuffney.com`
- Verify Route 53 records exist (for external access)
- Check domain is set correctly: `System → Settings → General` (should be `cuffney.com`)

**SSH not working with FQDN**:
- Verify DNS resolution: `nslookup numenor.cuffney.com`
- Check SSH config: `~/.ssh/config`
- Test with IP: `ssh jcuffney@192.168.1.10`
- Verify hostname is set: `hostnamectl` (should show FQDN)

**VPN not connecting**:
- Check WireGuard status: `VPN → WireGuard → Status`
- Verify firewall rules allow port 51820
- Check port forwarding if behind NAT
- Verify `shire.cuffney.com` resolves to public IP (for endpoint)
- Review WireGuard logs: `VPN → WireGuard → Log File`

**Services accessible from internet**:
- Review WAN firewall rules
- Ensure only port 51820 is forwarded
- Test from mobile data to verify blocking

**Domain not resolving externally**:
- Verify Route 53 A records exist for all hosts
- Check TTL values (300 seconds recommended)
- Wait for DNS propagation (can take a few minutes)
- Test from external network: `nslookup shire.cuffney.com`
