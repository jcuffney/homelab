# Task 1.11: Configure SSH Client Config (Local Machine)

**Objective**: Set up SSH config file for easy FQDN-based access using Middle Earth themed hostnames.

## Prerequisites

**Enable SSH on OPNsense** (if not already enabled):
- OPNsense has SSH disabled by default
- Navigate to: **System → Settings → Administration**
- Scroll to **Secure Shell** section
- Configure SSH settings:
  - **Enable Secure Shell**: ✅ Check this
  - **Root Login**: ✅ **Permit root user login** (needed for root SSH access)
  - **Authentication Method**: ✅ **Permit password login** (enable temporarily to add SSH key)
  - **SSH port**: Leave blank (defaults to 22)
  - **Listen Interfaces**: Leave empty (listens on all interfaces)
- Click **Save**

**Add SSH Key** (persistent method via GUI):
OPNsense manages SSH keys through the user management interface. Manual edits to `/root/.ssh/authorized_keys` don't persist because OPNsense regenerates this file from GUI settings.

1. **Get your public key** (on your local machine):
   ```bash
   cat ~/.ssh/id_ed25519.pub
   # Copy the output (starts with ssh-ed25519...)
   # Example: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHPbbBr45lG6kPU6Ii7T4Td79CibnKkXMpaOCT5kJpZx josephcuffney@gmail.com
   ```

2. **Add SSH key via OPNsense GUI** (persistent method):
   - Navigate to: **System → Access → Users**
   - Click on the **root** user (or find root in the list)
   - Click **Edit** (pencil icon)
   - Scroll down to **Authorized Keys** field
   - Paste your public key (the entire line from step 1)
   - Click **Save**

3. **Verify SSH key works**:
   ```bash
   ssh shire
   # Should connect without password prompt
   ```

4. **Disable password authentication** (for security):
   - In OPNsense: **System → Settings → Administration**
   - **Secure Shell** section
   - **Authentication Method**: ❌ **Uncheck "Permit password login"**
   - Click **Save**
   - **Note**: There's a known bug where disabling password login may clear authorized_keys. If this happens, re-add your key in **System → Access → Users → root → Authorized Keys**

5. **Test key-based authentication**:
   ```bash
   ssh shire
   # Should connect without password prompt
   ```

**Alternative: Manual method** (if GUI method doesn't work):
If the Authorized Keys field doesn't exist in the user settings, you can add the key manually, but you'll need to create a script or use a workaround to persist it across reboots. The GUI method is preferred as it persists automatically.

- See `../docs/opnsense-enable-ssh.md` for detailed instructions

**Steps**:
1. On your local machine (laptop/desktop), create/edit SSH config:
   ```bash
   mkdir -p ~/.ssh
   touch ~/.ssh/config
   chmod 600 ~/.ssh/config
   nano ~/.ssh/config
   ```

2. Add the following entries (Middle Earth themed names):
   ```ssh-config
   # OPNsense Router (shire)
   Host shire shire.cuffney.com
       HostName shire.cuffney.com
       User root
       Port 22
       IdentityFile ~/.ssh/id_ed25519

   # Proxmox Host (numenor)
   Host numenor numenor.cuffney.com
       HostName numenor.cuffney.com
       User root
       Port 22
       IdentityFile ~/.ssh/id_ed25519
   ```

3. Adjust `IdentityFile` to match your SSH key path if different
   - Default is `~/.ssh/id_ed25519`
   - Change to `~/.ssh/id_rsa` or your actual key path if different

**Test**:
```bash
# Test DNS resolution first
nslookup shire.cuffney.com
# Should resolve to: 192.168.1.1

nslookup numenor.cuffney.com
# Should resolve to: 192.168.1.10

# Test SSH connection using FQDNs
ssh shire
# Should connect to OPNsense (uses shire.cuffney.com)
# Note: OPNsense uses 'root' user by default

ssh numenor
# Should connect to Proxmox (uses numenor.cuffney.com)
# Note: Adjust user if different (root or jcuffney)

# Test SSH using short aliases (via search domain)
ssh shire
# Should connect to OPNsense

ssh numenor
# Should connect to Proxmox
```

**Expected Result**: Can SSH using FQDNs or short names: `ssh shire`, `ssh numenor`, `ssh shire.cuffney.com`, or `ssh numenor.cuffney.com`.

**Note**: 
- OPNsense (shire) uses `root` user by default
- Proxmox (numenor) may use `root` or `jcuffney` depending on your setup
- Adjust the `User` field in SSH config if your setup differs
